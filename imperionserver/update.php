<?php header('Access-Control-Allow-Origin: *');include 'dbvars.php';
$con=mysqli_connect($dbserver,$dbuser,$dbpass,$dbdata);
// Check connection
if (mysqli_connect_errno()) {  echo "Failed to connect to MySQL: " . mysqli_connect_error();}// escape variables for security$tipo = mysqli_real_escape_string($con, $_POST['tipo']);
$uId = mysqli_real_escape_string($con, $_POST['uId']);if ($tipo == 'updiplomacia'){	$sql="UPDATE tb_personagem set nr_diplomacia = nr_diplomacia + 1, nr_pontos = nr_pontos - 1 WHERE id_personagem = '$uId'";}if ($tipo == 'uptecnologia'){	$sql="UPDATE tb_personagem set nr_tecnologia = nr_tecnologia + 1, nr_pontos = nr_pontos - 1 WHERE id_personagem = '$uId'";}if ($tipo == 'uppoder'){	$sql="UPDATE tb_personagem set nr_poder = nr_poder + 1, nr_pontos = nr_pontos - 1 WHERE id_personagem = '$uId'";}if ($tipo == 'upcaptacao'){	$sql="UPDATE tb_personagem set nr_captacao = nr_captacao + 1, nr_pontos = nr_pontos - 1 WHERE id_personagem = '$uId'";}if ($tipo == 'upexp'){	$expup = $_POST['exp'];	$sql="SELECT nr_nivel, nr_exp_atual, nr_exp_next FROM tb_personagem WHERE id_personagem = $uId";	$getdata=mysqli_query($con,$sql);		$exp = 0;	$expnext = 0;	$nivel = 0;	while($row = $getdata->fetch_assoc()){		$exp = $row['nr_exp_atual'];		$expnext = $row['nr_exp_next'];		$nivel = $row['nr_nivel'];	}	$exp = $exp + $expup;		if ($exp >= $expnext)	{		$nivel = $nivel + 1;		$expnext = intval(floor((80.000000000 / 3)+10 * pow($nivel, 3) - (10 * pow($nivel, 2)) + ((850.000000000 / 3) * $nivel - 210))+700*$nivel);		//intval(floor((80.000000000 / 3) * pow($nivel, 3) - (80 * pow($nivel, 2)) + ((850.000000000 / 3) * $nivel - 210))); formato antio				   		echo "levelup;".$expnext.";x";		$sql= "UPDATE tb_personagem set nr_exp_atual = ".$exp.", nr_nivel = nr_nivel + 1, nr_pontos = nr_pontos + 5, nr_exp_base = nr_exp_next, nr_exp_next = ".$expnext." WHERE id_personagem = $uId";			}	else	{		$sql="UPDATE tb_personagem set nr_exp_atual = nr_exp_atual + ".$expup." WHERE id_personagem = $uId";	}}if ($tipo == 'dead'){	$sql = "SELECT nr_exp_atual, nr_exp_base, nr_ouro FROM tb_personagem WHERE id_personagem = $uId";	$getdata=mysqli_query($con,$sql);		$exp = 0;	$expbase = 0;	$ouro = 0;	while($row = $getdata->fetch_assoc()){		$exp = $row['nr_exp_atual'];		$expbase = $row['nr_exp_base'];		$ouro = $row['nr_ouro'];	}	$ouro = intval($ouro - ($ouro * 0.1));	$exp = intval($exp - ($exp * 0.1)); 	if ($expbase < $exp)	{		$expbase = $exp;	}	$sql = "UPDATE tb_personagem set nr_exp_atual = ".$exp.", nr_exp_base = ".$expbase.", nr_ouro = ".$ouro." WHERE id_personagem = $uId";}if ($tipo == 'melhorarbase'){	$sql = "SELECT nr_custo_nivel FROM tb_centro_comando WHERE id_personagem = $uId";	$getdata=mysqli_query($con,$sql);	$custo = 0;	while($row = $getdata->fetch_assoc()){		$custo = $row['nr_custo_nivel'];			}		$sql="UPDATE tb_centro_comando set nr_nivel = nr_nivel + 1, nr_personagem_nivel = nr_personagem_nivel + 5, nr_custo_nivel = nr_personagem_nivel * 1000 WHERE id_personagem = '$uId'";			if (!mysqli_query($con,$sql)) {	  die('Error: ' . mysqli_error($con));	}		$sql="UPDATE tb_personagem set nr_ouro = nr_ouro - ".$custo." WHERE id_personagem = $uId";	}if ($tipo == 'melhorarfabricas'){	$sql = "SELECT nr_custo_nivel FROM tb_fabrica WHERE id_personagem = $uId";	$getdata=mysqli_query($con,$sql);	$custo = 0;	while($row = $getdata->fetch_assoc()){		$custo = $row['nr_custo_nivel'];			}		$sql="UPDATE tb_fabrica set nr_nivel = nr_nivel + 1, nr_tecnologia_nivel = nr_tecnologia_nivel + 3, nr_custo_nivel = nr_tecnologia_nivel * 300 WHERE id_personagem = '$uId'";			if (!mysqli_query($con,$sql)) {	  die('Error: ' . mysqli_error($con));	}		$sql="UPDATE tb_personagem set nr_ouro = nr_ouro - ".$custo." WHERE id_personagem = $uId";	}if ($tipo == 'melhorarcentropesquisa'){	$sql = "SELECT id_personagem, nr_custo_nivel FROM tb_centro_pesquisa WHERE id_centro_pesquisa = $uId";	$getdata=mysqli_query($con,$sql);	$idpersonagem = 0;	$custo = 0;	while($row = $getdata->fetch_assoc()){		$idpersonagem = $row['id_personagem'];		$custo = $row['nr_custo_nivel'];			}	$sql="UPDATE tb_centro_pesquisa set nr_nivel = nr_nivel + 1, nr_tecnologia_nivel = nr_tecnologia_nivel + 5, nr_custo_nivel = nr_tecnologia_nivel * 600, nr_pontos = nr_pontos + 3 WHERE id_centro_pesquisa = '$uId'";				if (!mysqli_query($con,$sql)) {	  die('Error: ' . mysqli_error($con));	}		$sql="UPDATE tb_personagem set nr_ouro = nr_ouro - ".$custo." WHERE id_personagem =". $idpersonagem;	}if ($tipo == 'leave'){	$hp = $_POST["hp"];	$mp = $_POST["mp"];		$sql="UPDATE tb_personagem set nr_energia = ".$hp.", nr_combustivel = ".$mp." WHERE id_personagem = $uId";	}if ($tipo == 'getouro'){	$ouro = $_POST["ouro"];	$sql="UPDATE tb_personagem set nr_ouro = nr_ouro + ".$ouro." WHERE id_personagem = $uId";}if ($tipo == 'melhorarpericia'){	$pericia = mysqli_real_escape_string($con, $_POST['pericia']);	$sql="UPDATE tb_pericia_centro set nr_nivel = nr_nivel + 1 WHERE id_pericia = $pericia AND id_centro_pesquisa = '$uId'";				if (!mysqli_query($con,$sql)) {	  die('Error: ' . mysqli_error($con));	}		$sql="UPDATE tb_centro_pesquisa set nr_pontos = nr_pontos - 1 WHERE id_centro_pesquisa = '$uId'";		}if ($tipo == 'melhorarminas'){	$sql = "SELECT id_personagem, nr_custo_nivel FROM tb_mina WHERE id_mina = $uId";	$getdata=mysqli_query($con,$sql);	$customina = 0;	while($row = $getdata->fetch_assoc()){		$idpersonagem = $row['id_personagem'];		$customina = $row['nr_custo_nivel'];			}	$sql="UPDATE tb_mina set nr_nivel = nr_nivel + 1, nr_captacao_nivel = nr_captacao_nivel + 3, nr_custo_nivel = nr_captacao_nivel * 500 WHERE id_mina = '$uId'";				if (!mysqli_query($con,$sql)) {	  die('Error: ' . mysqli_error($con));	}		$sql="UPDATE tb_personagem set nr_ouro = nr_ouro - ".$customina." WHERE id_personagem =". $idpersonagem;			}if ($tipo == 'captacao'){	$sql = "SELECT id_personagem, nr_ouro, nr_cristal, nr_plutonio, nr_nivel FROM tb_mina WHERE id_mina = $uId";	$getdata=mysqli_query($con,$sql);	$idpersonagem = 0;	$temouro = 0;	$templuto = 0;	$temcristal = 0;	$nivelmina = 0;	while($row = $getdata->fetch_assoc()){		$idpersonagem = $row['id_personagem'];		$temouro = $row['nr_ouro'];		$templuto = $row['nr_plutonio'];		$temcristal = $row['nr_cristal'];		$nivelmina = $row['nr_nivel'];	}		$sql = "UPDATE tb_personagem SET nr_ouro = nr_ouro + ".$temouro.", nr_cristal = nr_cristal + ".$temcristal." WHERE id_personagem = ".$idpersonagem;		if (!mysqli_query($con,$sql)) {	  die('Error: ' . mysqli_error($con));	}		$captacao = 0;	$sql = "SELECT nr_captacao FROM tb_personagem WHERE id_personagem = ".$idpersonagem;	$getdata=mysqli_query($con,$sql);	while($row = $getdata->fetch_assoc()){		$captacao = $row['nr_captacao'];	}		$ouro = rand ($nivelmina, $nivelmina + 9);	$ouro = $ouro * 100;		$pluto = rand(0,5*$nivelmina);	$pluto = $pluto * 10;	$cristal = rand(0,100);	$percristal = 70;	if ($nivelmina >= 5)	{		$percristal = 65;	}	if ($nivelmina >= 10)	{		$percristal = 60;	}	if ($nivelmina >= 15)	{		$percristal = 55;	}	if ($nivelmina >= 20)	{		$percristal = 50;	}	if ($cristal <= $percristal)	{		$cristal = 0;	}	else	{		$cristal = 1;	}	$minutos = intval(30-($captacao/5));		$formatDate = date("Y-m-d H:i:s",strtotime(date("Y-m-d H:i:s")." +".$minutos." minutes"));	echo $formatDate.";".$ouro.";".$pluto.";".$cristal;	$sql="UPDATE tb_mina set nr_ouro = ".$ouro.", nr_plutonio = ".$pluto.", nr_cristal = ".$cristal.", dt_acao = '".$formatDate."' WHERE id_mina = ".$uId;}
if (!mysqli_query($con,$sql)) {
  die('Error: ' . mysqli_error($con));
}
//echo "1 record updated";
mysqli_close($con);?>